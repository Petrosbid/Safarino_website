{% extends 'base/base.html' %}
{% load static %}
{% load extras %}

{% block title %}{{ post.0.title }} | سفرینو{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="{% static 'static_main/css/postblog.css' %}"/>
<link rel="stylesheet" href="{% static 'static_main/css/comments.css' %}"/>
{% endblock %}

{% block extra_js %}
<script src="https://kit.fontawesome.com/9d1d9a82d2.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js"></script>
<script src="https://cdn.lordicon.com/lordicon.js"></script>
<script src="{% static 'static_main/javascript/blogPost.js' %}"></script>
<script src="{% static 'static_main/javascript/comments.js' %}"></script>
{% endblock %}

{% block content %}
<div  class="blogpost-hero animate__animated animate__fadeInDown" style="
    background-image: url('{% static 'static_main/images/20852675_6345959-compressed.jpg' %}');">
    <h1>{{ post.0.title }}</h1>
    <div class="meta">
        <span>تعداد بازدید: {{ post.0.views}}</span>
        <span>•</span>
        <span>{{ post.0.created_at|jdate:"%Y/%m/%d" }}</span>
        <span>•</span>
        <span>{{ post.content|read_time }} دقیقه مطالعه</span>
    </div>
</div>
<div class="blogpost-layout">
    <div class="blogpost-main animate__animated animate__fadeInUp">

        <div class="blogpost-card">
            <div class="author">
                {% if post.0.author.profile_image %}
                    <img src="{{ post.0.author.profile_image.url }}" alt="{{ post.0.author.username }}">
                {% else %}
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ post.0.author.username }}" alt="avatar">
                {% endif %}
                <span class="author-role">نویسنده: </span>
                {% if post.0.author.first_name != "" %}
                    <span>{{ post.0.author.first_name }} {{ post.0.author.last_name }}</span>
                {% else %}
                    <span>{{ post.0.author.username }}</span>
                {% endif %}

                <div class="share-buttons">
                    <a href="#" class="twitter-share-button share-btn">
                        <lord-icon
                            src="https://cdn.lordicon.com/vnvsnvov.json"
                            trigger="hover"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:50px;height:50px">
                        </lord-icon>
                    </a>
                    <a href="#" class="share-btn">
                        <lord-icon
                            src="https://cdn.lordicon.com/axewyqun.json"
                            trigger="hover"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:50px;height:50px">
                        </lord-icon>
                    </a>
                    <a href="#" class="share-btn">
                        <lord-icon
                            src="https://cdn.lordicon.com/kxnplube.json"
                            trigger="hover"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:50px;height:50px">
                        </lord-icon>
                    </a>
                </div>
            </div>
            {% if post.0.image %}
                <div class="featured-image">
                    <img src="{{ post.0.image.url }}" alt="{{ post.0.title }}">
                </div>
            {% endif %}
            <div class="post-body">
                {{ post.0.content|safe }}
            </div>

            <hr style="margin-bottom: 10px">

            <div class="tags">
                <span class="tag-label">برچسب‌ها:</span>
                {% for category in post.0.category|categories %}
                    <a href="#" class="tag">{{ category }}</a>
                {% endfor %}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="share-post">
                    <span class="share-label">مورد پسند بود:</span>
                    <a href="#" class="share-btn">
                        <lord-icon
                            src="https://cdn.lordicon.com/msyeyaka.json"
                            trigger="hover"
                            state="hover-up"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:50px;height:50px">
                        </lord-icon>
                    </a>
                    <a href="#" class="share-btn">
                        <lord-icon
                            src="https://cdn.lordicon.com/msyeyaka.json"
                            trigger="hover"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:50px;height:50px">
                        </lord-icon>
                    </a>
                    <span>{{ post.0.likes }}</span>
                </div>
                <div class="share-post">
                    <span class="share-label">اشتراک‌گذاری:</span>
                    <a href="#" class="twitter-share-button share-btn">
                        <lord-icon
                            src="https://cdn.lordicon.com/vnvsnvov.json"
                            trigger="hover"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:50px;height:50px">
                        </lord-icon>
                    </a>
                    <a href="#" class="share-btn">
                        <lord-icon
                            src="https://cdn.lordicon.com/axewyqun.json"
                            trigger="hover"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:50px;height:50px">
                        </lord-icon>
                    </a>
                    <a href="#" class="share-btn">
                        <lord-icon
                            src="https://cdn.lordicon.com/kxnplube.json"
                            trigger="hover"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:50px;height:50px">
                        </lord-icon>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <aside class="blogpost-sidebar animate__animated animate__fadeInLeft">
        <div id="toc-placeholder"></div>
        <div class="related-posts">
            <h3>مقالات مرتبط</h3>
            {% get_related_posts post.0 as related_posts %}
            <div class="related-posts-grid">
                {% for related_post in related_posts %}
                <div class="related-post">
                    <div class="post-image">
                        {% if related_post.image %}
                            <img src="{{ related_post.image.url }}" alt="{{ related_post.title }}">
                        {% else %}
                            <img src="https://source.unsplash.com/400x200/?travel,trip,nature" alt="سفر">
                        {% endif %}
                    </div>
                    <div class="post-meta">
                        <span>{{ related_post.category|default:'سفر' }}</span>
                        <span>•</span>
                        <span>{{ related_post.created_at|jdate:"%Y/%m/%d" }}</span>
                    </div>
                    <div class="post-title">{{ related_post.title }}</div>
                    <a href="/blog/{{ related_post.id }}" class="read-more">ادامه مطلب</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </aside>
</div>

<!-- Comment Section -->
<div class="comments-section animate__animated animate__fadeInUp">
    <h3>نظرات ({{ comments.count }})</h3>
    
    {% if user.is_authenticated %}
    <div class="comment-form">
        <form method="POST" action="{% url 'comments:add_comment' %}">
            {% csrf_token %}
            <input type="hidden" name="content_type" value="blog.post">
            <input type="hidden" name="object_id" value="{{ post.0.id }}">
            <textarea name="text" placeholder="نظر خود را بنویسید..." required></textarea>
            <button type="submit" class="submit-comment">ارسال نظر</button>
        </form>
    </div>
    {% else %}
    <div class="login-to-comment">
        <p>برای ارسال نظر، لطفا <a href="{% url 'login' %}">وارد شوید</a> یا <a href="{% url 'login' %}">ثبت نام کنید</a>.</p>
    </div>
    {% endif %}

    <div class="comments-list">
        {% for comment in comments %}
        <div class="comment {% if comment.status == 'approved' %}approved{% else %}pending{% endif %}">
            <div class="comment-header">
                {% if comment.user.profile_image %}
                    <img src="{{ comment.user.profile_image.url }}" alt="{{ comment.user.username }}" class="comment-avatar">
                {% else %}
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ comment.user.username }}" alt="avatar" class="comment-avatar">
                {% endif %}
                <div class="comment-info">
                    <span class="comment-author">
                        {% if comment.user.first_name %}
                            {{ comment.user.first_name }} {{ comment.user.last_name }}
                        {% else %}
                            {{ comment.user.username }}
                        {% endif %}
                    </span>
                    <span class="comment-date">{{ comment.created_at|jdate:"%Y/%m/%d" }}</span>
                </div>
            </div>
            <div class="comment-content">
                {{ comment.text }}
            </div>
            <div class="comment-actions">
                <button class="like-button" data-comment-id="{{ comment.id }}">
                        <lord-icon
                            src="https://cdn.lordicon.com/msyeyaka.json"
                            trigger="hover"
                            state="hover-up"
                            stroke="bold"
                            colors="primary:#121331,secondary:#2b4162"
                            style="width:35px;height:35px">
                        </lord-icon>
                    <span class="likes-count">{{ comment.likes }}</span>
                </button>
            </div>
        </div>
        {% empty %}
        <div class="no-comments">
            <p>هنوز نظری ثبت نشده است. اولین نظر را شما ثبت کنید!</p>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}
